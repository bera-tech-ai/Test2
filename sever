
import express from "express";
import fetch from "node-fetch";

const app = express();
app.use(express.json());
app.use(express.static(".")); // serve index.html + script.js

const PAYHERO_API_KEY = "v38BZT005Qx8NYjYnCIT";
const PAYHERO_API_SECRET = "PCTduYGpbr2r9Ae6xWt9YBUrQgNQhrMS5";
const CALLBACK_URL = "https://test2-peach-iota.vercel.app/"; // your callback

// Convert to Base64 token
const authToken = Buffer.from(`${PAYHERO_API_KEY}:${PAYHERO_API_SECRET}`).toString("base64");

// STK push endpoint
app.post("/api/stkpush", async (req, res) => {
  const { phone } = req.body;

  try {
    const response = await fetch("https://api.payhero.co.ke/api/v2/payments/initiate", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Basic ${authToken}`,
      },
      body: JSON.stringify({
        amount: 1,
        currency: "KES",
        channel: "M-PESA",
        phone,
        callback_url: CALLBACK_URL,
        external_reference: "TestTX-" + Date.now(),
        provider: "M-PESA",
        reason: "STK Push Test",
      }),
    });

    const data = await response.json();
    res.json(data);
  } catch (error) {
    res.json({ success: false, message: error.message });
  }
});

app.listen(3000, () => console.log("âœ… Server running on port 3000"));
